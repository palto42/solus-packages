name       : epsonscan2
version    : 6.7.80
release    : 5
source     :
    - https://download3.ebz.epson.net/dsc/f/03/00/17/08/06/1babf9876ebb16956420a601b92ee28b57cd7db7/epsonscan2-6.7.80.0-1.src.tar.gz : f8d617892e75fb43404824e627a4c5894f7e1283bb9840d7cdecfbcef24b2097
homepage   : https://support.epson.net/linux/en/epsonscan2.php
license    : GPL-2.1-or-later
component  : office
summary    : Epson Scan 2
description: |
    Software for Epson scanners & multifunction printer
builddeps  :
    - pkgconfig(libusb-1.0)
    - pkgconfig(sane-backends)

    - pkgconfig(zlib)
    - pkgconfig(libtiff-4)
    - pkgconfig(libpng)
    - rapidjson
    - pkgconfig(Qt5Core)
    - libharu-devel
    - libboost-devel
    - libjpeg-turbo-devel
setup      : |
    # ls -l

    # Patch CMakeLists
    sed -i 's|/lib/udev|${CMAKE_INSTALL_PREFIX}/lib/udev|' "CMakeLists.txt"
    sed -i '1 i #include "zlib.h"' "src/CommonUtility/DbgLog.cpp"
    sed -i '/zlib/d' "src/Controller/CMakeLists.txt"

    # Stability improvements from Flatpak maintainers
    # https://github.com/flathub/net.epson.epsonscan2
    %apply_patches

    # Remove Boost setting in CMake config that crashes the package build
    find . -type f -name CMakeLists.txt \
        -exec sed -i '/BOOST_NO_CXX11_RVALUE_REFERENCES/d' {} \;

    for file in Standalone/lastusedsettings.cpp \
                Standalone/defaultsettings.cpp \
                CommonUtility/ESCommonTypedef.h \
                Controller/Src/KeysValues/Key.hpp \
                Controller/Src/KeysValues/KeyMgr.hpp
    do
        sed -i '/BOOST_NO_CXX11_RVALUE_REFERENCES/d' \
            "src/$file"
    done

    # Fix compilation failure caused by GCC 15
    sed -i '/SET.*FLAGS/ s/")/ -Wno-template-body")/' \
            "src/ES2Command/Linux/CMakeLists.txt"
    sed -i '/#include/ i #include <cmath>' \
            "src/Controller/Src/Filter/GrayToMono.hpp"

    %cmake_ninja \
        -DCMAKE_BUILD_TYPE=Release \
        -DCMAKE_INSTALL_PREFIX=/usr \
        -DQT_VERSION_MAJOR=5
build      : |
    %ninja_build
install    : |
    %ninja_install

    install -d $installdir/usr/lib64/sane
    install -Dm644 "$installdir/usr/lib64/epsonscan2/libsane-epsonscan2.so" \
        "$installdir/usr/lib64/sane/libsane-epsonscan2.so"

    # Add desktop file
    install -Dm644 "$workdir/desktop/rpm/i686/epsonscan2.desktop" \
        "$installdir/usr/share/applications/epsonscan2.desktop"

    # Rename doc folder
    mv "$installdir/usr/share/doc/epsonscan2-1.0.0.0-1" "$installdir/usr/share/doc/epsonscan2-${version}-1"
    
    # Add metainfo file
    install -Dm644 "$pkgfiles/net.epson.epsonscan2.metainfo.xml" \
        "$installdir/usr/share/metainfo/net.epson.epsonscan2.metainfo.xml"

    # Remove unwanted files
    rm "$installdir/usr/share/doc/epsonscan2-${version}-1/changelog.Debian"